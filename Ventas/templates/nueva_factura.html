{% extends "base.html" %}
{% load static %}

{% block title %} Nueva Venta {% endblock title %}

{% block content %}

    <div style="color:#575757; font-weight: bold; font-size: 3rem; border-bottom: 1px solid white;">Nueva Venta</div>
    
    <br>

    <form method="post" class="panel panel-default">
        
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="panel-heading panel-heading-text">Detalles del Cliente</div>
        <div class="panel-body">
        
            <!-- Mostrar errores para cada campo -->
            {{ form.nombre.errors }}
            {{ form.telefono.errors }}
            {{ form.correo_electronico.errors }}
            {{ form.direccion.errors }}
            {{ form.nit.errors }}
        
            <div class="form-row">
                <label for="{{ form.nombre.id_for_label }}" class="panel-body-text">Nombre del Cliente:</label>
                {{ form.nombre }}                
            </div>
            <div class="form-row">
                <label for="{{ form.telefono.id_for_label }}" class="panel-body-text">Teléfono:</label>
                {{ form.telefono }}
            </div>
            <div class="form-row">              
                <label for="{{ form.correo_electronico.id_for_label }}" class="panel-body-text">Correo Electrónico:</label>
                {{ form.correo_electronico }}
            </div>
        
            <div class="form-row">
                <label for="{{ form.direccion.id_for_label }}" class="panel-body-text">Dirección:</label>
                {{ form.direccion }}  
            </div>
            
            <div class="form-row">
                <label for="{{ form.nit.id_for_label }}" class="panel-body-text">NIT:</label>
                {{ form.nit }}  
            </div>
        </div>
        <br>

        <div class="panel panel-default">
            
            {{ formset.management_form }}

            <div class="panel-heading panel-heading-text">Detalles del Producto</div>
            
            <div id="stockitem"> 
                <div class="panel-body">
                    {% for iform in formset %}
                        <div class="row form-row">
                            <div class="form-group col-md-3">
                                {{ iform.stock.errors }}
                                <label class="panel-body-text">Producto:</label>
                                {{ iform.stock }}
                            </div>
                            <div class="form-group col-md-3">
                                <label class="panel-body-text">Precio:</label>
                                <input type="text" class="textinput form-control" name="{{ iform.precio_unitario.name }}" value="{{ iform.precio_unitario.value }}" readonly>
                            </div>
                            <div class="form-group col-md-2">
                                {{ iform.cantidad.errors }}
                                <label class="panel-body-text">Cantidad:</label>
                                {{ iform.cantidad }}
                            </div>
                            <div class="form-group col-md-3">
                                <label class="panel-body-text">Total:</label>
                                <input type="text" class="textinput form-control totalprice" name="{{ iform.precio_total.name }}" value="{{ iform.precio_total.value }}" readonly required>
                            </div>
                            <div class="form-group col-md-1">
                                <label class="panel-body-text" style="color: #000">.</label>
                                <button class="form-control btn btn-danger remove-form-row" type="button"><i class="bi bi-trash3"></i></button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <br>

            <div class="align-middle">
                <button type="submit" class="btn btn-success">Pagar</button>
                <a href="{% url 'ventas-lista' %}" class="btn btn-secondary">Cancelar</a>
            </div>
            
        </div>

    </form>

    <!-- JavaScript personalizado para agregar y eliminar formularios -->
    <script type="text/javascript" src="{% static 'js/jquery-3.2.1.slim.min.js' %}"></script>
    <script type="text/javascript">
        // Crea un objeto de alerta personalizado
        function custom_alert() {
            this.render = function(message) {
                alert(message);  // Puedes personalizar esto para usar un modal o un div
            };
        }

        // Mantén el objeto de alerta
        var alertInstance = new custom_alert();

        document.addEventListener('DOMContentLoaded', function () {
            const stockFields = document.querySelectorAll('.stock');

            stockFields.forEach(stockField => {
                stockField.addEventListener('change', function () {
                    const stockId = this.value;
                    const precioUnitarioField = this.closest('.form-row').querySelector('[name$="precio_unitario"]');

                    if (stockId) {
                        fetch(`/api/stock/${stockId}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.precio) {
                                    precioUnitarioField.value = data.precio;
                                    updateTotal(this.closest('.form-row'));
                                }
                            })
                            .catch(error => console.error('Error al obtener el precio:', error));
                    } else {
                        precioUnitarioField.value = '';
                    }
                });
            });

            // Actualiza el total al cambiar cantidad o precio unitario
            function updateTotal(row) {
                const cantidadField = row.querySelector('[name$="cantidad"]');
                const precioUnitarioField = row.querySelector('[name$="precio_unitario"]');
                const totalField = row.querySelector('[name$="precio_total"]');

                const cantidad = parseFloat(cantidadField.value) || 0;
                const precioUnitario = parseFloat(precioUnitarioField.value) || 0;
                const total = cantidad * precioUnitario;

                totalField.value = total.toFixed(2);
            }

            // Escucha los cambios en la cantidad
            document.querySelectorAll('[name$="cantidad"]').forEach(cantidadField => {
                cantidadField.addEventListener('change', function () {
                    updateTotal(this.closest('.form-row'));
                });
            });

            // Eliminar formulario
            $(document).on('click', '.remove-form-row', function(e){
                e.preventDefault();
                const row = $(this).closest('.form-row');
                const cantidadField = row.find('[name$="cantidad"]');
                const stockId = row.find('.stock').val();
                
                if (confirm("¿Estás seguro de que deseas eliminar este producto?")) {
                    row.remove();
                    alertInstance.render('Producto eliminado');
                }
            });

            // Monitorear el cambio en la cantidad para alertas de stock
            document.querySelectorAll('[name$="cantidad"]').forEach(cantidadField => {
                cantidadField.addEventListener('change', function () {
                    const cantidad = parseFloat(this.value) || 0;
                    const stockId = this.closest('.form-row').querySelector('.stock').value;
                    
                    // Aquí puedes agregar tu lógica de verificación de stock
                    fetch(`/api/stock/${stockId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (cantidad > data.quantity) {
                                alertInstance.render('Cantidad excede el stock disponible.');
                                this.value = data.quantity; // Ajustar cantidad a stock disponible
                                updateTotal(this.closest('.form-row'));
                            }
                        })
                        .catch(error => console.error('Error al verificar el stock:', error));
                });
            });
        });
    </script>

{% endblock content %}
